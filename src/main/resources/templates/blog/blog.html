<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org/" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title th:text="${blog != null} ? ${blog.title} : 'My Blog'">My Blog</title>
    <link rel="stylesheet" href="/css/blog.css">
    <script src="/js/header.js"></script>
    <link rel="stylesheet" href="/css/header.css">
</head>
<body>
<div class="bodyContent">
    <th:block th:replace="~{fragments/header :: headerFragment}"></th:block>

    <div class="profile-section">
        <div class="profile-image">
            <img th:src="${blogUser.profileImageUrl}" alt="Profile Image" />
        </div>
        <div class="profile-info">
            <h2 th:text="${blogUser.name}">User Name</h2>
            <p th:text="'@' + ${blogUser.username}">Username</p>
            <div class="follow-info">
                <span th:text="${followerCount}">3</span> 팔로워
                <span th:text="${followingCount}">0</span> 팔로잉
            </div>
            <div th:if="${blogUser.username != user.username}">
                <button id="follow-btn" class="follow-button">
                    <span th:text="${isFollowing ? '팔로우 취소' : '팔로우'}">팔로우</span>
                </button>
            </div>
        </div>
    </div>

    <div class="cover-image" th:if="${blog != null && blog.coverImageUrl != null}">
        <img th:src="${blog.coverImageUrl}" alt="Cover Image">
    </div>

    <div th:if="${blog == null}">
        <p>No blog found.</p>
    </div>

    <div th:if="${blog != null}">
        <section>
            <h2>Posts</h2>
            <div class="posts-grid">
                <div th:each="post : ${posts}" class="post-card">
                    <a th:href="@{'/post?username=' + ${user.username} + '&blogId=' + ${blog.id} + '&postId=' + ${post.id}}" class="post-link">
                        <div class="post-content">
                            <h3 th:text="${post.title}">Post Title</h3>
                            <div th:if="${postService.extractFirstImageUrl(post.content) != null}" class="image-container">
                                <img th:src="${postService.extractFirstImageUrl(post.content)}" alt="Post Image" class="post-image">
                            </div>
                            <div th:unless="${postService.extractFirstImageUrl(post.content) != null}" class="image-container">
                                <img th:src="@{/images/default-image.png}" alt="Default Image" class="post-image">
                            </div>
                            <p class="post-meta">Published on <span th:text="${post.createAt}">Date</span></p>
                        </div>
                    </a>
                </div>
            </div>
        </section>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const followBtn = document.getElementById('follow-btn');
        const blogUserId = [[${blogUser.id}]];
        const userId = [[${user.id}]];
        const isFollowing = [[${isFollowing}]];

        async function toggleFollow() {
            // const isFollowing = await fetch(`/api/follow/status?userId=${blogUserId}&followerId=${currentUserId}`)
            //     .then(response => response.json());
            console.log(isFollowing);

            if (isFollowing) {
                console.log("팔로우취소 들어와라 js")
                await fetch(`/api/follow/${blogUserId}?userId=${userId}`, { method: 'DELETE' });
                followBtn.textContent = '팔로우';
            } else {
                await fetch(`/api/follow/${blogUserId}?userId=${userId}`, { method: 'POST' });
                followBtn.textContent = '팔로우 취소';
            }
        }

        followBtn.addEventListener('click', toggleFollow);
    });
</script>
</body>
</html>

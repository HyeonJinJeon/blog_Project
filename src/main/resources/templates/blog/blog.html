<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org/" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title th:text="${blog != null} ? ${blog.title} : 'My Blog'">My Blog</title>
    <link rel="stylesheet" href="/css/blog.css">
    <script src="/js/header.js"></script>
    <link rel="stylesheet" href="/css/header.css">
</head>
<body>
<div class="bodyContent">
    <th:block th:replace="~{fragments/header :: headerFragment}"></th:block>

    <div class="profile-section">
        <div class="profile-image">
            <img th:src="${blogUser.profileImageUrl}" alt="Profile Image" />
        </div>
        <div class="profile-info">
            <h2 th:text="${blogUser.name}">User Name</h2>
            <p th:text="${blogUser.username}">Username</p>
        </div>
        <div class="follow-info">
            <span id="followerCount" th:text="${followerCount}">3</span> 팔로워
            <span th:text="${followingCount}">0</span> 팔로잉
            <span>&nbsp;</span>
            <button th:if="${blogUser.username != user.username}" id="follow-btn" class="follow-button">
                <span th:text="${isFollowing ? '팔로우 취소' : '팔로우'}">팔로우</span>
            </button>
        </div>
    </div>

    <div class="cover-image" th:if="${blog != null && blog.coverImageUrl != null}">
        <img th:src="${blog.coverImageUrl}" alt="Cover Image">
    </div>

    <div th:if="${blog == null}">
        <p>No blog found.</p>
    </div>

    <div th:if="${blog != null}">
        <section>
            <div class="tab-menu">
                <a href="#" class="active">글</a>
                <a th:href="@{'/blog/series?username=' + ${blogUser.username}}">시리즈</a>
                <a href="#">소개</a>
            </div>
            <div class="search-bar">
                <input type="text" placeholder="검색어를 입력하세요">
                <button>검색</button>
            </div>
            <!--            <h2>Posts</h2>-->
            <div class="posts-grid">
                <div th:each="post : ${posts}" class="post-card">
                    <a th:href="@{'/post?blogId=' + ${blog.id} + '&postId=' + ${post.id}}" class="post-link">
                        <div class="post-content">
                            <h3 th:text="${post.title}">Post Title</h3>
                            <div th:if="${postService.extractFirstImageUrl(post.content) != null}" class="image-container">
                                <img th:src="${postService.extractFirstImageUrl(post.content)}" alt="Post Image" class="post-image">
                            </div>
                            <div th:unless="${postService.extractFirstImageUrl(post.content) != null}" class="image-container">
                                <img th:src="@{/images/default-image.png}" alt="Default Image" class="post-image">
                            </div>
                            <p class="post-meta">Published on <span th:text="${post.createdAt}">Date</span></p>
                        </div>
                    </a>
                </div>
            </div>
        </section>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("버튼 클릭")
        const followBtn = document.getElementById('follow-btn');
        const followerCountElement = document.getElementById('followerCount');
        let followerCount = parseInt(followerCountElement.textContent);
        const blogUserId = [[${blogUser.id}]];
        const userId = [[${user.id}]];
        let isFollowing = [[${isFollowing}]];

        async function toggleFollow() {
            try {
                if (isFollowing) {
                    const response = await fetch(`/api/follow/${blogUserId}?userId=${userId}`, { method: 'DELETE' });
                    if (response.ok) {
                        followBtn.textContent = '팔로우';
                        isFollowing = false;
                        followerCount--;
                    }
                } else {
                    const response = await fetch(`/api/follow/${blogUserId}?userId=${userId}`, { method: 'POST' });
                    if (response.ok) {
                        followBtn.textContent = '팔로우 취소';
                        isFollowing = true;
                        followerCount++;
                    }
                }
                followerCountElement.textContent = followerCount;
            } catch (error) {
                console.error('팔로우 상태를 변경하는 중 오류가 발생했습니다.', error);
            }
        }

        followBtn.addEventListener('click', toggleFollow);
    });
</script>
</body>
</html>
